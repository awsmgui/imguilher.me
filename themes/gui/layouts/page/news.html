{{ define "main" }}
<div class="list-page">
    <h1 class="list-title">{{ .Title }}</h1>

    <div id="feed-container">
        <p class="loading-message">Carregando notícias...</p>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const feedContainer = document.getElementById("feed-container");
        const rssFeeds = [
            "https://www.intigriti.com/blog/feed"
        ];

        async function fetchFeeds() {
            feedContainer.innerHTML = `<p class="loading-message">Buscando os feeds mais recentes...</p>`;
            let allItems = [];
            const proxyUrl = "https://api.rss2json.com/v1/api.json?rss_url=";

            // Usamos Promise.all para buscar todos os feeds em paralelo
            const feedPromises = rssFeeds.map(async (url) => {
                try {
                    const response = await fetch(proxyUrl + encodeURIComponent(url));
                    if (!response.ok) {
                        // Se a resposta da rede não for 'ok' (ex: erro 500, 404)
                        throw new Error(`Erro de rede: ${response.statusText}`);
                    }
                    const data = await response.json();
                    if (data.status === 'ok') {
                        data.items.forEach(item => item.feedTitle = data.feed.title);
                        return data.items;
                    } else {
                        // Se a API rss2json retornar um erro
                        console.error(`API rss2json retornou erro para o feed: ${url}`, data.message);
                        return []; // Retorna uma lista vazia para este feed
                    }
                } catch (error) {
                    console.error(`Falha crítica ao buscar o feed: ${url}`, error);
                    return []; // Retorna uma lista vazia se a busca falhar
                }
            });

            // Espera todas as buscas terminarem
            const results = await Promise.all(feedPromises);
            results.forEach(items => {
                if (items) {
                    allItems.push(...items);
                }
            });

            // Ordena todos os itens por data
            allItems.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            displayItems(allItems);
        }

        function displayItems(items) {
            if (items.length === 0) {
                feedContainer.innerHTML = "<p>Não foi possível carregar as notícias no momento. Verifique a Console do Desenvolvedor (F12) para mais detalhes.</p>";
                return;
            }
            let html = "";
            items.forEach(item => {
                const pubDate = new Date(item.pubDate).toLocaleDateString('pt-BR');
                const description = new DOMParser().parseFromString(item.description, 'text/html').body.textContent || "";
                html += `<article class="feed-item"><h3 class="feed-item-title"><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a></h3><p class="feed-item-meta">Por <strong>${item.author || item.feedTitle}</strong> em ${pubDate}</p><p class="feed-item-description">${description.substring(0, 150)}...</p></article>`;
            });
            feedContainer.innerHTML = html;
        }

        fetchFeeds();
    });
</script>
{{ end }}
